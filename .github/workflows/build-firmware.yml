name: Build TollGate OS (OpenWRT Firmware)

on:
  push:
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Run at midnight UTC every day

jobs:
  build:
    strategy:
      matrix:
        model: [
          #'gl-mt300n-v2',
          #'gl-ar300m16',
          'gl-ar300m',
          'gl-ar300m-nor',
          'gl-mt3000',
          'gl-mt6000',
#          'gl-e750',
#          'archer_mr200'
        ]
      fail-fast: false

    runs-on: ubuntu-latest
    name: Build ${{ matrix.model }}

    steps:
      - uses: actions/checkout@v4

      - id: commit-hash
        uses: prompt/actions-commit-hash@v3

      - name: Set version variable
        id: determine-os-version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # If this is a tag push, use the tag name
            echo "version=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          else
            # If this is a branch push, use branch-shortCommitHash format
            echo "version=${GITHUB_REF_NAME}-${{ steps.commit-hash.outputs.short }}" >> $GITHUB_OUTPUT
          fi
        
      - name: Set version variable
        id: determine-release-channel
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "channel=stable" >> $GITHUB_OUTPUT
          else
            echo "channel=dev" >> $GITHUB_OUTPUT
          fi

      - name: Build OpenWRT Image
        id: build-openwrt-image
        uses: ./actions/build-firmware
        with:
          model: ${{ matrix.model }}
          nostr_secret_key: ${{ secrets.NOSTR_SECRET_KEY }}
          nostr_public_key: ${{ secrets.NOSTR_PUBLIC_KEY }}
          files_path: "./files"
          nsecbech: ${{ secrets.NSECBECH }}
          nsec: ${{ secrets.NSEC }}
          # openwrt_version: '24.10.1'
          tollgate_os_version: ${{ steps.determine-os-version.outputs.version }}
          release_channel: ${{ steps.determine-release-channel.outputs.channel }}
      
      - name: Upload Firmware Artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.model }}.img
          path: ${{ steps.build-openwrt-image.outputs.firmware_path }}
          retention-days: 5
